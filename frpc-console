#!/bin/bash
#
# FRP Console - FRP 客户端多开管理控制台
#

APP_DIR="/opt/frp-console"
CONFIG_FILE="${APP_DIR}/frp-console.conf"
APP_NAME="frp-console"

RED=$'\033[0;31m'
GREEN=$'\033[0;32m'
YELLOW=$'\033[1;33m'
CYAN=$'\033[0;36m'
NC=$'\033[0m'

log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

load_config() {
    if [[ -f "$CONFIG_FILE" ]]; then
        source <(grep '=' "$CONFIG_FILE" | sed 's/^/export /')
    fi
}

print_menu() {
    clear
    echo -e "${CYAN}╔════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║      FRP Console 控制台            ║${NC}"
    echo -e "${CYAN}║      FRP 客户端多开管理            ║${NC}"
    echo -e "${CYAN}╚════════════════════════════════════╝${NC}"
    echo ""
    echo "  ${GREEN}1.${NC}  启动服务"
    echo "  ${GREEN}2.${NC}  停止服务"
    echo "  ${GREEN}3.${NC}  重启服务"
    echo "  ${GREEN}4.${NC}  查看状态"
    echo "  ${GREEN}5.${NC}  查看日志"
    echo "  ${GREEN}6.${NC}  查看信息"
    echo "  ${GREEN}7.${NC}  设置端口"
    echo "  ${GREEN}8.${NC}  设置密码"
    echo "  ${GREEN}9.${NC}  安装系统服务"
    echo "  ${GREEN}0.${NC}  退出"
    echo ""
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
}

cmd_start() {
    load_config
    PORT=${PORT:-7601}
    cd "$APP_DIR"
    nohup python3 -m flask --app app/app.py run --host=0.0.0.0 --port=$PORT > $APP_DIR/logs/frp-console.log 2>&1 &
    log_info "服务已启动 (端口: $PORT)"
    sleep 1
}

cmd_stop() {
    ps aux 2>/dev/null | grep "flask --app" | grep -v grep | awk '{print $2}' | xargs -r kill 2>/dev/null || true
    log_info "服务已停止"
}

cmd_restart() {
    cmd_stop
    sleep 1
    cmd_start
}

cmd_status() {
    local pid=$(ps aux 2>/dev/null | grep "flask --app" | grep -v grep | awk '{print $2}' | head -1)
    if [[ -n "$pid" ]]; then
        load_config
        PORT=${PORT:-7601}
        log_info "服务运行中 (PID: $pid, 端口: $PORT)"
        echo "访问: http://localhost:$PORT"
    else
        log_warn "服务未运行"
    fi
}

cmd_logs() {
    if [[ -f "$APP_DIR/logs/frp-console.log" ]]; then
        tail -f $APP_DIR/logs/frp-console.log
    else
        log_error "日志文件不存在"
    fi
}

cmd_info() {
    load_config
    echo ""
    echo -e "${CYAN}┌────────────────────────────────────┐${NC}"
    echo -e "${CYAN}│         当前配置信息               │${NC}"
    echo -e "${CYAN}└────────────────────────────────────┘${NC}"
    echo ""
    echo "  端口:      ${PORT:-7601}"
    echo "  用户名:    ${ADMIN_USER:-admin}"
    echo "  配置文件:  $CONFIG_FILE"
    echo "  日志目录:  $APP_DIR/logs"
    echo ""
}

cmd_set_port() {
    load_config
    echo -n "请输入端口号 [$PORT]: "
    read new_port
    new_port=${new_port:-$PORT}
    
    if [[ ! "$new_port" =~ ^[0-9]+$ ]] || [[ $new_port -lt 1 ]] || [[ $new_port -gt 65535 ]]; then
        log_error "无效端口号"
        return
    fi
    
    sed -i "s/^PORT=.*/PORT=$new_port/" "$CONFIG_FILE"
    log_info "端口已设置为: $new_port"
    cmd_restart
}

cmd_set_pass() {
    load_config
    echo -n "请输入新密码: "
    read -s new_pass
    echo ""
    
    if [[ ${#new_pass} -lt 8 ]]; then
        log_error "密码长度至少8位"
        return
    fi
    
    sed -i "s/^ADMIN_PASSWORD=.*/ADMIN_PASSWORD=$new_pass/" "$CONFIG_FILE"
    log_info "密码已更新"
}

cmd_install() {
    log_info "正在安装 FRP Console 服务..."
    
    if [[ ! -f "/etc/systemd/system/${APP_NAME}.service" ]]; then
        cat > /etc/systemd/system/${APP_NAME}.service << SERVICEEOF
[Unit]
Description=FRP Console - FRP Client Management Panel
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=${APP_DIR}
EnvironmentFile=${CONFIG_FILE}
ExecStart=/usr/bin/python3 -m flask --app ${APP_DIR}/app/app.py run --host=0.0.0.0 --port=\${PORT}
Restart=always

[Install]
WantedBy=multi-user.target
SERVICEEOF
        systemctl daemon-reload
        systemctl enable ${APP_NAME}
        log_info "系统服务安装完成"
    fi
    
    systemctl start ${APP_NAME}
    log_info "服务已启动"
}

main_menu() {
    load_config
    
    while true; do
        print_menu
        echo -n "请输入选项 [0-9]: "
        read choice
        
        case "$choice" in
            1) cmd_start; sleep 1; echo "按回车继续..."; read ;;
            2) cmd_stop; sleep 1; echo "按回车继续..."; read ;;
            3) cmd_restart; sleep 1; echo "按回车继续..."; read ;;
            4) cmd_status; echo "按回车继续..."; read ;;
            5) cmd_logs ;;
            6) cmd_info; echo "按回车继续..."; read ;;
            7) cmd_set_port; echo "按回车继续..."; read ;;
            8) cmd_set_pass; echo "按回车继续..."; read ;;
            9) cmd_install; echo "按回车继续..."; read ;;
            0) echo "再见！"; exit 0 ;;
            *) log_error "无效选项"; sleep 1 ;;
        esac
    done
}

main_menu
